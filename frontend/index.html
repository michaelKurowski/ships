<html>
    <head></head>
    <body>

        <canvas id="canvas" width="800" height="600"></canvas>

        <script src='https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js'></script>
        <script>
          
            const canvas = document.getElementById('canvas')
            const context = canvas.getContext('2d')

            const socket = io('http://localhost:3000')

            const OBJECT_TYPES = ['PLAYER','PROJECTILE']
            const fps = 1000 / 30

            let objects = {}
            let playerID = ''

            const modulo = (firstNumber, secondNUmber) => (firstNumber % secondNUmber + secondNUmber) % secondNUmber
            
            class Vector2d {
		        constructor(x,y){
			        this.x = x,
			        this.y = y
		        }
	        }

            class GameObject {
                constructor(size, position, speed, texture, objectType) {
                    this.size = size,
                    this.position = position
                    this.updatedPosition = new Vector2d(0,0)
                    this.texture = texture
                    this.speed = speed
                    this.objectType = objectType
                }

                swapPositionOnBoard(borderWidth, borderHeight){
                    this.updatedPosition.x = modulo(this.position.x, borderWidth)
                    this.updatedPosition.y = modulo(this.position.y, borderHeight)
                }

                isOnBoard(borderWidth, borderHeight){
                    return this.position.x >=0 && this.position.x <= borderWidth && this.position.y >= 0 && this.position.y <= borderHeight
                }

                moveXAxis(direction) {
			        this.updatedPosition.x = this.position.x + (this.speed * direction)
		        }
	
		        moveYAxis(direction) {
			        this.updatedPosition.y += this.position.y + (this.speed * direction)
		        }
                
            }
            
            socket.on('spawn',object => {
                playerID = object.objectId
                console.log(`on spawn: ${object.objectId}`)
                objects[playerID] = new GameObject(new Vector2d(20,20), object.position, 10,'',OBJECT_TYPES[0])
            })

            socket.on('move',object => {
                console.log(`on move: ${object.objectId}`)
                objects[object.objectId].position = object.position
            })

            function init(){
		        window.addEventListener('keypress', controller)
	        }

            function render() {
                Object.values(objects).forEach( gameObject => {

                    context.strokeRect(
                        gameObject.position.x,
                        gameObject.position.y,
                        gameObject.size.x,
                        gameObject.size.y
                    )
                })

            }

            function updatePlayerPosition(id, playerGameObject){

                if(playerGameObject.objectType === OBJECT_TYPES[0])
                    playerGameObject.swapPositionOnBoard(canvas.width, canvas.height)

                console.log(`emit move: ${id}`)
                socket.emit('move', {objectId: id, position: playerGameObject.updatedPosition})
            }

            function controller(event){
                const keyNumber = event.charCode
                const playerObject = objects[playerID]
                switch(keyNumber){
                case 119: {		//w
                    playerObject.moveYAxis(-1) 
                    break
                }	
                    
                case 115:{ 		//s
                    playerObject.moveYAxis(1)
                    break
                }	

                case 97: {		//a
                    playerObject.moveXAxis(-1)
                    break	
                }
                    
                case 100: {		//d
                    playerObject.moveXAxis(1)
                    break
                }		
                }
                updatePlayerPosition(playerID, playerObject)
            }

            function updateContext(){
                context.clearRect(0, 0, canvas.width, canvas.height)
                render()
            }

            init()
            setInterval(updateContext,fps)
        </script>


    </body>
</html>

